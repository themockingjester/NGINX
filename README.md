# NGINX

![Nginx Logo](https://miro.medium.com/max/1400/1*z7-lgU_f9u7IXzuMa9Cebw.png)

## Useful commands in nginx for ubuntu

##### sudo nginx OR sudo systemctl start nginx  (for starting nginx)
##### sudo nginx -t (update nginx setting after updating config file)
##### sudo systemctl reload nginx (for reloading nginx)
##### sudo systemctl restart nginx (for restating nginx)
##### sudo systemctl stop nginx (for stopping nginx)

## Basic structure for nginx server config file (having both frontend and backend deployed)
![image](https://user-images.githubusercontent.com/44976021/179823620-7bb10265-1f5d-4abd-8859-c992bbe94c63.png)

```
upstream loadbalancer {
  least_conn;		# load balancing algorithm provided by nginx
  server localhost:3500;
  server localhost:3501;
  server localhost:3502;
  server localhost:3503;
}

server {

	index index.html index.htm index.nginx-debian.html;
	server_name example.com www.example.com;

        # react app & front-end files
        location / {
                root /root/frontend/build;
                try_files $uri /index.html;
        }
	
	# backend app
        location /api/ {
                proxy_pass http://loadbalancer/;
                proxy_buffering         on;
        }

}
```

## Important and Helpful files of nginx
##### 1) error log file path ->  /var/log/nginx/error.log (holds information what wrong happend while making request to server)
##### 2) config file path ->  /etc/nginx/sites-available/default (holds the data as shown above)
##### 3) access file path -> /var/log/nginx/access.log (tracks record of successfull requests on server)

## Best Source For Deploying Both Front End And Backend On Same Server
https://medium.com/geekculture/deploying-a-react-app-and-a-node-js-server-on-a-single-machine-with-pm2-and-nginx-15f17251ee74

## For Generating SSl Certificate for server
```
sudo snap install core; 
sudo snap refresh core
sudo snap install --classic certbot
sudo ln -s /snap/bin/certbot /usr/bin/certbot
sudo certbot --nginx

...

```
#### After installing certificate you might the want to access those files (certificate file and key file ) directly from lets enscrypt folder then you will get an error <br>
To fix this error:
# chmod 755 /etc/letsencrypt/live/
# chmod 755 /etc/letsencrypt/archive/
# ll /etc/letsencrypt/
total 0
drwxr-xr-x. 3 root root 38 Sep 28 11:24 archive
drwxr-xr-x. 3 root root 38 Sep 28 11:24 live
You can also test Certbotâ€™s automatic renewal: ```sudo certbot renew --dry-run```



## basic structure for /etc/nginx/nginx.conf (just for idea purpose)

```
user www-data;
worker_processes auto;
pid /run/nginx.pid;
include /etc/nginx/modules-enabled/*.conf;

events {
        worker_connections 768;
        multi_accept on;

}


http {

        ##
        # Basic Settings
        ##

        sendfile on;
        tcp_nopush on;
        types_hash_max_size 2048;
        server_tokens off;
        # server_names_hash_bucket_size 64;
        # server_name_in_redirect off;

        include /etc/nginx/mime.types;
	default_type application/octet-stream;

        ##
        # SSL Settings
        ##

        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3; # Dropping SSLv3, ref: POODLE
        ssl_prefer_server_ciphers on;

        ##
        # Logging Settings
        ##
	access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log;
     
        ##
        # Gzip Settings
        ##

        gzip on;
        # gzip_min_length 100;

        # gzip_vary on;
        # gzip_proxied any;
        # gzip_comp_level 3;
        # gzip_buffers 16 8k;
	# gzip_http_version 1.1;
        # gzip_types text/css text/xml application/xml application/xml+rss text/javascript;
        # gzip_disable "msie6";
        ##
        # Virtual Host Configs
        ##
        
        # client_body_buffer_size 16k;
        # client_header_buffer_size 1k;
        client_max_body_size 25m;
        # large_client_header_buffers 2 1k;
        
        include /etc/nginx/conf.d/*.conf;
        include /etc/nginx/sites-enabled/*;
}

```

## Nginx Configuration for multiple server on one system (with rate limiting)

### /etc/nginx/sites-available/default (file)
```
upstream loadbalancer {
  least_conn;           # load balancing algorithm provided by nginx
  server localhost:5000;
}

limit_req_zone $binary_remote_addr zone=mylimit:10m rate=10r/s;
server {
        # SSL configuration
        #
        # listen 443 ssl default_server;
        # listen [::]:443 ssl default_server;
        #
        # Note: You should disable gzip for SSL traffic.
        # See: https://bugs.debian.org/773332
        #
        # Read up on ssl_ciphers to ensure a secure configuration.
        # See: https://bugs.debian.org/765782
        #
        # Self signed certs generated by the ssl-cert package
	# Don't use them in a production server!
        #
        # include snippets/snakeoil.conf;

        #root /var/www/html;

        # Add index.php to the list if you are using PHP
        index index.html index.htm index.nginx-debian.html;

        server_name abc.domain.in www.abc.domain.in;
	location / {
                # First attempt to serve request as file, then
                # as directory, then fall back to displaying a 404.
                include /etc/nginx/mime.types;
                root /home/ubuntu/project_abc/build;
                try_files $uri /index.html =404;
        }


    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/abc.domain.in/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/abc.domain.in/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
    }


# Virtual Host configuration for example.com
#
# You can move that to a different file under sites-available/ and symlink that
# to sites-enabled/ to enable it.
server {

        server_name xyz.domain.in www.xyz.domain.in;
        index index.html index.htm;

        location / {
                include /etc/nginx/mime.types;
                root /home/ubuntu/project_xyz/build;
                try_files $uri /index.html =404;
        }
       # backend app
        location /app/ {
                limit_req zone=mylimit burst=20 nodelay;
                proxy_pass http://loadbalancer/;
                proxy_buffering         on;
		    }

    listen [::]:443 ssl ipv6only=on; # managed by Certbot
    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/xyz.domain.in/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/xyz.domain.in/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

}
server {
    if ($host = abc.domain.in) {
        return 301 https://$host$request_uri;
    } # managed by Certbot



        server_name abc.domain.in www.abc.domain.in;
    listen 80;
    return 404; # managed by Certbot
    }


server {
    if ($host = xyz.domain.in) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


        listen 80;
        listen [::]:80;

        server_name xyz.domain.in www.xyz.domain.in;
    return 404; # managed by Certbot
    
}
```

